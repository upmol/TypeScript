const database = [
  {
    id: "vnd331",
    title: "Radisson Royal Hotel",
    details:
      "Отель расположен в 4 минутах ходьбы от станции метро «Маяковская». К услугам гостей фитнес-центр и спа-центр с сауной и гидромассажной ванной.",
    photos: ["vnd331.png", "vnd331.png"],
    coordinates: [59.9322936, 30.3460129],
    bookedDates: [],
    price: 12000,
  },
  {
    id: "ab2e2",
    title: "Номера на Садовой",
    details:
      "Расположен в 7 минутах ходьбы от Невского проспекта. К услугам гостей круглосуточная стойка регистрации и бесплатный Wi-Fi.",
    photos: ["ab2e2.png", "ab2e2.png"],
    coordinates: [59.930325, 30.3291592],
    bookedDates: [],
    price: 4500,
  },
  {
    id: "mvm32l",
    title: "Мини Отель на Невском 136",
    details:
      "Мини-отель расположен в Санкт-Петербурге, в 5 минутах ходьбы от станции метро «Площадь Восстания» и Московского железнодорожного вокзала.",
    photos: ["mvm32l.png", "mvm32l.png"],
    coordinates: [59.9299603, 30.3658932],
    bookedDates: [],
    price: 3800,
  },
  {
    id: "bvep12",
    title: "Отель Усадьба Державина",
    details:
      "Прекрасный отель недалеко от Исаакиевского собора с бесплатным Wi-Fi на всей территории.",
    photos: ["bvep12.png", "bvep12.png"],
    coordinates: [59.9194966, 30.309389],
    bookedDates: [],
    price: 8700,
  },
];
export function cloneDate(date) {
  return new Date(date.getTime());
}
export function addDays(date, days) {
  date.setDate(date.getDate() + days);
  return date;
}
export const backendPort = 3040;
export const localStorageKey = "flat-rent-db";
export class FlatRentSdk {
  constructor() {
    this._generateTransactionId = () => {
      const min = 1000;
      const max = 9999;
      const num = Math.random() * (max - min) + min;
      return Math.floor(num);
    };
    if (this._readDatabase() == null) {
      this._writeDatabase(database);
    }
    this.database = this._readDatabase();
  }
  /**
   * Get flat by ID.
   *
   * @param {string} id Flat ID.
   * @returns {Promise<Object|null>} Flat.
   */
  get(id) {
    const flat = this.database.find((item) => {
      return item.id === id;
    });
    return Promise.resolve(flat == null ? flat : this._formatFlatObject(flat));
  }
  /**
   * Search for flats.
   *
   * @param {Object} parameters Search parameters
   * @param {string}parameters.city City name
   * @param {Date} parameters.checkInDate Check-in date
   * @param {Date} parameters.checkOutDate Check-out date
   * @param {number} [parameters.priceLimit] Max price for a night
   * @returns {Object[]} List of suitable flats.
   */
  search(parameters) {
    return new Promise((resolve, reject) => {
      try {
        if (parameters.city != "Санкт-Петербург") {
          throw new Error(`Passed unsupported city - "${parameters.city}".`);
        }
        if (
          !(parameters.checkInDate instanceof Date) ||
          !(parameters.checkOutDate instanceof Date)
        ) {
          throw new Error(
            `Passed invalid check-in or check-out date - from "${parameters.checkInDate}" to "${parameters.checkOutDate}".`
          );
        }
        this._assertDatesAreCorrect(
          parameters.checkInDate,
          parameters.checkOutDate
        );
        if (
          parameters.priceLimit != null &&
          (isNaN(parameters.priceLimit) || !isFinite(parameters.priceLimit))
        ) {
          throw new Error(
            `Passed invalid price limit - "${parameters.priceLimit}".`
          );
        }
        let flats = this.database;
        if (parameters.priceLimit != null) {
          flats = flats.filter((flat) => {
            return flat.price <= parameters.priceLimit;
          });
        }
        const dateRange = this._generateDateRange(
          parameters.checkInDate,
          parameters.checkOutDate
        );
        flats = flats.filter((flat) => {
          return this._areAllDatesAvailable(flat, dateRange);
        });
        flats = flats.map((flat) => {
          return this._formatFlatObject(flat, dateRange.length - 1);
        });
        resolve(flats);
      } catch (error) {
        reject(error);
      }
    });
  }
  /**
   * Book flat.
   *
   * @param {number} flatId
   * @param {Date} checkInDate
   * @param {Date} checkOutDate
   * @returns {number}
   */
  book(flatId, checkInDate, checkOutDate) {
    return new Promise((resolve, reject) => {
      try {
        const flat = this.database.find((item) => {
          return item.id === flatId;
        });
        if (flat == null) {
          throw new Error('There is no flat with ID "' + flatId + '".');
        }
        this._assertDatesAreCorrect(checkInDate, checkOutDate);
        const datesToBook = this._generateDateRange(checkInDate, checkOutDate);
        if (!this._areAllDatesAvailable(flat, datesToBook)) {
          throw new Error(
            `Flat ${flat.id} is not available for dates ${datesToBook.join(
              ","
            )}.`
          );
        }
        const bookedDates = datesToBook.map((date) => {
          return date.getTime();
        });
        flat.bookedDates.push(...bookedDates);
        for (let i = 0; i < this.database.length; i++) {
          if (this.database[i].id === flat.id) {
            this.database[i] = flat;
            break;
          }
        }
        this._writeDatabase(this.database);
        resolve(this._generateTransactionId());
      } catch (error) {
        reject(error);
      }
    });
  }
  _assertDatesAreCorrect(checkInDate, checkOutDate) {
    const today = new Date();
    this._resetTime(today);
    this._resetTime(checkInDate);
    this._resetTime(checkOutDate);
    const diffToday = this._calculateDifferenceInDays(today, checkInDate);
    if (diffToday < 0) {
      throw new Error("Check-in date can't be in the past.");
    }
    const diffCheck = this._calculateDifferenceInDays(
      checkInDate,
      checkOutDate
    );
    if (diffCheck < 0) {
      throw new Error("Check-out date must be grater then check-in date.");
    }
  }
  _resetTime(date) {
    date.setHours(0);
    date.setMinutes(0);
    date.setSeconds(0);
    date.setMilliseconds(0);
  }
  _calculateDifferenceInDays(startDate, endDate) {
    const difference = endDate.getTime() - startDate.getTime();
    return Math.floor(difference / (1000 * 60 * 60 * 24));
  }
  _generateDateRange(from, to) {
    const dates = [];
    const differenceInDays = this._calculateDifferenceInDays(from, to);
    dates.push(new Date(from.getFullYear(), from.getMonth(), from.getDate()));
    for (let i = 1; i <= differenceInDays; i++) {
      dates.push(
        new Date(from.getFullYear(), from.getMonth(), from.getDate() + i)
      );
    }
    return dates;
  }
  _areAllDatesAvailable(flat, dateRange) {
    return dateRange.every((date) => {
      return !flat.bookedDates.includes(date.getTime());
    });
  }
  _formatFlatObject(flat, nightNumber) {
    const formattedFlat = Object.assign({}, flat);
    formattedFlat.photos = formattedFlat.photos.map((photoUrl) => {
      return `http://localhost:${backendPort}/img/${photoUrl}`;
    });
    if (nightNumber != null) {
      formattedFlat.totalPrice = nightNumber * formattedFlat.price;
      delete formattedFlat.price;
    }
    return formattedFlat;
  }
  _readDatabase() {
    const data = window.localStorage.getItem(localStorageKey);
    if (data == null) {
      return data;
    }
    return JSON.parse(data);
  }
  _writeDatabase(database) {
    window.localStorage.setItem(localStorageKey, JSON.stringify(database));
  }
  _syncDatabase(database) {
    this._writeDatabase(database);
    this.database = this._readDatabase();
  }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmxhdC1yZW50LXNkay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZGsvZmxhdC1yZW50LXNkay5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxNQUFNLFFBQVEsR0FBRztJQUNmO1FBQ0UsRUFBRSxFQUFFLFFBQVE7UUFDWixLQUFLLEVBQUUsc0JBQXNCO1FBQzdCLE9BQU8sRUFBRSxnSkFBZ0o7UUFDekosTUFBTSxFQUFFLENBQUMsWUFBWSxFQUFFLFlBQVksQ0FBQztRQUNwQyxXQUFXLEVBQUUsQ0FBQyxVQUFVLEVBQUMsVUFBVSxDQUFDO1FBQ3BDLFdBQVcsRUFBRSxFQUFFO1FBQ2YsS0FBSyxFQUFFLEtBQUs7S0FDYjtJQUNEO1FBQ0UsRUFBRSxFQUFFLE9BQU87UUFDWCxLQUFLLEVBQUUsbUJBQW1CO1FBQzFCLE9BQU8sRUFBRSw2SEFBNkg7UUFDdEksTUFBTSxFQUFFLENBQUMsV0FBVyxFQUFFLFdBQVcsQ0FBQztRQUNsQyxXQUFXLEVBQUUsQ0FBQyxTQUFTLEVBQUMsVUFBVSxDQUFDO1FBQ25DLFdBQVcsRUFBRSxFQUFFO1FBQ2YsS0FBSyxFQUFFLElBQUk7S0FDWjtJQUNEO1FBQ0UsRUFBRSxFQUFFLFFBQVE7UUFDWixLQUFLLEVBQUUsMkJBQTJCO1FBQ2xDLE9BQU8sRUFBRSwySUFBMkk7UUFDcEosTUFBTSxFQUFFLENBQUMsWUFBWSxFQUFFLFlBQVksQ0FBQztRQUNwQyxXQUFXLEVBQUUsQ0FBQyxVQUFVLEVBQUMsVUFBVSxDQUFDO1FBQ3BDLFdBQVcsRUFBRSxFQUFFO1FBQ2YsS0FBSyxFQUFFLElBQUk7S0FDWjtJQUNEO1FBQ0UsRUFBRSxFQUFFLFFBQVE7UUFDWixLQUFLLEVBQUUseUJBQXlCO1FBQ2hDLE9BQU8sRUFBRSwwRkFBMEY7UUFDbkcsTUFBTSxFQUFFLENBQUMsWUFBWSxFQUFFLFlBQVksQ0FBQztRQUNwQyxXQUFXLEVBQUUsQ0FBQyxVQUFVLEVBQUMsU0FBUyxDQUFDO1FBQ25DLFdB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QUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFBO1FBRTdDLGFBQWEsQ0FBQyxNQUFNLEdBQUcsYUFBYSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRTtZQUMzRCxPQUFPLG9CQUFvQixXQUFXLFFBQVEsUUFBUSxFQUFFLENBQUE7UUFDMUQsQ0FBQyxDQUFDLENBQUE7UUFFRixJQUFJLFdBQVcsSUFBSSxJQUFJLEVBQUU7WUFDdkIsYUFBYSxDQUFDLFVBQVUsR0FBRyxXQUFXLEdBQUcsYUFBYSxDQUFDLEtBQUssQ0FBQTtZQUM1RCxPQUFPLGFBQWEsQ0FBQyxLQUFLLENBQUE7U0FDM0I7UUFFRCxPQUFPLGFBQWEsQ0FBQTtJQUN0QixDQUFDO0lBRUQsYUFBYTtRQUNYLE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFBO1FBRXpELElBQUksSUFBSSxJQUFJLElBQUksRUFBRTtZQUNoQixPQUFPLElBQUksQ0FBQTtTQUNaO1FBRUQsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFBO0lBQ3pCLENBQUM7SUFFRCxjQUFjLENBQUMsUUFBUTtRQUNyQixNQUFNLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxlQUFlLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFBO0lBQ3hFLENBQUM7SUFFRCxhQUFhLENBQUMsUUFBUTtRQUNwQixJQUFJLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxDQUFBO1FBQzdCLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFBO0lBQ3RDLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IGRhdGFiYXNlID0gW1xuICB7XG4gICAgaWQ6ICd2bmQzMzEnLFxuICAgIHRpdGxlOiAnUmFkaXNzb24gUm95YWwgSG90ZWwnLFxuICAgIGRldGFpbHM6ICfQntGC0LXQu9GMINGA0LDRgdC/0L7Qu9C+0LbQtdC9INCyIDQg0LzQuNC90YPRgtCw0YUg0YXQvtC00YzQsdGLINC+0YIg0YHRgtCw0L3RhtC40Lgg0LzQtdGC0YDQviDCq9Cc0LDRj9C60L7QstGB0LrQsNGPwrsuINCaINGD0YHQu9GD0LPQsNC8INCz0L7RgdGC0LXQuSDRhNC40YLQvdC10YEt0YbQtdC90YLRgCDQuCDRgdC/0LAt0YbQtdC90YLRgCDRgSDRgdCw0YPQvdC+0Lkg0Lgg0LPQuNC00YDQvtC80LDRgdGB0LDQttC90L7QuSDQstCw0L3QvdC+0LkuJyxcbiAgICBwaG90b3M6IFsndm5kMzMxLnBuZycsICd2bmQzMzEucG5nJ10sXG4gICAgY29vcmRpbmF0ZXM6IFs1OS45MzIyOTM2LDMwLjM0NjAxMjldLFxuICAgIGJvb2tlZERhdGVzOiBbXSxcbiAgICBwcmljZTogMTIwMDBcbiAgfSxcbiAge1xuICAgIGlkOiAnYWIyZTInLFxuICAgIHRpdGxlOiAn0J3QvtC80LXRgNCwINC90LAg0KHQsNC00L7QstC+0LknLFxuICAgIGRldGFpbHM6ICfQoNCw0YHQv9C+0LvQvtC20LXQvSDQsiA3INC80LjQvdGD0YLQsNGFINGF0L7QtNGM0LHRiyDQvtGCINCd0LXQstGB0LrQvtCz0L4g0L/RgNC+0YHQv9C10LrRgtCwLiDQmiDRg9GB0LvRg9Cz0LDQvCDQs9C+0YHRgtC10Lkg0LrRgNGD0LPQu9C+0YHRg9GC0L7Rh9C90LDRjyDRgdGC0L7QudC60LAg0YDQtdCz0LjRgdGC0YDQsNGG0LjQuCDQuCDQsdC10YHQv9C70LDRgtC90YvQuSBXaS1GaS4nLFxuICAgIHBob3RvczogWydhYjJlMi5wbmcnLCAnYWIyZTIucG5nJ10sXG4gICAgY29vcmRpbmF0ZXM6IFs1OS45MzAzMjUsMzAuMzI5MTU5Ml0sXG4gICAgYm9va2VkRGF0ZXM6IFtdLFxuICAgIHByaWNlOiA0NTAwXG4gIH0sXG4gIHtcbiAgICBpZDogJ212bTMybCcsXG4gICAgdGl0bGU6ICfQnNC40L3QuCDQntGC0LXQu9GMINC90LAg0J3QtdCy0YHQutC+0LwgMTM2JyxcbiAgICBkZXRhaWxzOiAn0JzQuNC90Lgt0L7RgtC10LvRjCDRgNCw0YHQv9C+0LvQvtC20LXQvSDQsiDQodCw0L3QutGCLdCf0LXRgtC10YDQsdGD0YDQs9C1LCDQsiA1INC80LjQvdGD0YLQsNGFINGF0L7QtNGM0LHRiyDQvtGCINGB0YLQsNC90YbQuNC4INC80LXRgtGA0L4gwqvQn9C70L7RidCw0LTRjCDQktC+0YHRgdGC0LDQvdC40Y/CuyDQuCDQnNC+0YHQutC+0LLRgdC60L7Qs9C+INC20LXQu9C10LfQvdC+0LTQvtGA0L7QttC90L7Qs9C+INCy0L7QutC30LDQu9CwLicsXG4gICAgcGhvdG9zOiBbJ212bTMybC5wbmcnLCAnbXZtMzJsLnBuZyddLFxuICAgIGNvb3JkaW5hdGVzOiBbNTkuOTI5OTYwMywzMC4zNjU4OTMyXSxcbiAgICBib29rZWREYXRlczogW10sXG4gICAgcHJpY2U6IDM4MDBcbiAgfSxcbiAge1xuICAgIGlkOiAnYnZlcDEyJyxcbiAgICB0aXRsZTogJ9Ce0YLQtdC70Ywg0KPRgdCw0LTRjNCx0LAg0JTQtdGA0LbQsNCy0LjQvdCwJyxcbiAgICBkZXRhaWxzOiAn0J/RgNC10LrRgNCw0YHQvdGL0Lkg0L7RgtC10LvRjCDQvdC10LTQsNC70LXQutC+INC+0YIg0JjRgdCw0LDQutC40LXQstGB0LrQvtCz0L4g0YHQvtCx0L7RgNCwINGBINCx0LXRgdC/0LvQsNGC0L3Ri9C8IFdpLUZpINC90LAg0LLRgdC10Lkg0YLQtdGA0YDQuNGC0L7RgNC40LguJyxcbiAgICBwaG90b3M6IFsnYnZlcDEyLnBuZycsICdidmVwMTIucG5nJ10sXG4gICAgY29vcmRpbmF0ZXM6IFs1OS45MTk0OTY2LDMwLjMwOTM4OV0sXG4gICAgYm9va2VkRGF0ZXM6IFtdLFxuICAgIHByaWNlOiA4NzAwXG4gIH1cbl1cblxuZXhwb3J0IGZ1bmN0aW9uIGNsb25lRGF0ZShkYXRlKSB7XG4gIHJldHVybiBuZXcgRGF0ZShkYXRlLmdldFRpbWUoKSlcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGFkZERheXMoZGF0ZSwgZGF5cykge1xuICBkYXRlLnNldERhdGUoZGF0ZS5nZXREYXRlKCkgKyBkYXlzKVxuICByZXR1cm4gZGF0ZVxufVxuXG5leHBvcnQgY29uc3QgYmFja2VuZFBvcnQgPSAzMDQwXG5leHBvcnQgY29uc3QgbG9jYWxTdG9yYWdlS2V5ID0gJ2ZsYXQtcmVudC1kYidcblxuZXhwb3J0IGNsYXNzIEZsYXRSZW50U2RrIHtcbiAgY29uc3RydWN0b3IoKSB7XG4gICAgaWYgKHRoaXMuX3JlYWREYXRhYmFzZSgpID09IG51bGwpIHtcbiAgICAgIHRoaXMuX3dyaXRlRGF0YWJhc2UoZGF0YWJhc2UpXG4gICAgfVxuXG4gICAgdGhpcy5kYXRhYmFzZSA9IHRoaXMuX3JlYWREYXRhYmFzZSgpXG4gIH1cblxuICAvKipcbiAgICAgKiBHZXQgZmxhdCBieSBJRC5cbiAgICAgKiBcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gaWQgRmxhdCBJRC5cbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZTxPYmplY3R8bnVsbD59IEZsYXQuXG4gICAgICovXG4gIGdldChpZCkge1xuICAgIGNvbnN0IGZsYXQgPSB0aGlzLmRhdGFiYXNlLmZpbmQoKGl0ZW0pID0+IHtcbiAgICAgIHJldHVybiBpdGVtLmlkID09PSBpZFxuICAgIH0pXG5cbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGZsYXQgPT0gbnVsbCA/IGZsYXQgOiB0aGlzLl9mb3JtYXRGbGF0T2JqZWN0KGZsYXQpKVxuICB9XG5cbiAgLyoqXG4gICAgICogU2VhcmNoIGZvciBmbGF0cy5cbiAgICAgKiBcbiAgICAgKiBAcGFyYW0ge09iamVjdH0gcGFyYW1ldGVycyBTZWFyY2ggcGFyYW1ldGVyc1xuICAgICAqIEBwYXJhbSB7c3RyaW5nfXBhcmFtZXRlcnMuY2l0eSBDaXR5IG5hbWVcbiAgICAgKiBAcGFyYW0ge0RhdGV9IHBhcmFtZXRlcnMuY2hlY2tJbkRhdGUgQ2hlY2staW4gZGF0ZVxuICAgICAqIEBwYXJhbSB7RGF0ZX0gcGFyYW1ldGVycy5jaGVja091dERhdGUgQ2hlY2stb3V0IGRhdGVcbiAgICAgKiBAcGFyYW0ge251bWJlcn0gW3BhcmFtZXRlcnMucHJpY2VMaW1pdF0gTWF4IHByaWNlIGZvciBhIG5pZ2h0XG4gICAgICogQHJldHVybnMge09iamVjdFtdfSBMaXN0IG9mIHN1aXRhYmxlIGZsYXRzLlxuICAgICAqL1xuICBzZWFyY2gocGFyYW1ldGVycykge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBpZiAocGFyYW1ldGVycy5jaXR5ICE9ICfQodCw0L3QutGCLdCf0LXRgtC10YDQsdGD0YDQsycpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFBhc3NlZCB1bnN1cHBvcnRlZCBjaXR5IC0gXCIke3BhcmFtZXRlcnMuY2l0eX1cIi5gKVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCEocGFyYW1ldGVycy5jaGVja0luRGF0ZSBpbnN0YW5jZW9mIERhdGUpIHx8ICEocGFyYW1ldGVycy5jaGVja091dERhdGUgaW5zdGFuY2VvZiBEYXRlKSkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgUGFzc2VkIGludmFsaWQgY2hlY2staW4gb3IgY2hlY2stb3V0IGRhdGUgLSBmcm9tIFwiJHtwYXJhbWV0ZXJzLmNoZWNrSW5EYXRlfVwiIHRvIFwiJHtwYXJhbWV0ZXJzLmNoZWNrT3V0RGF0ZX1cIi5gKVxuICAgICAgICB9XG4gICAgICAgIHRoaXMuX2Fzc2VydERhdGVzQXJlQ29ycmVjdChwYXJhbWV0ZXJzLmNoZWNrSW5EYXRlLCBwYXJhbWV0ZXJzLmNoZWNrT3V0RGF0ZSlcblxuICAgICAgICBpZiAocGFyYW1ldGVycy5wcmljZUxpbWl0ICE9IG51bGwgJiYgKGlzTmFOKHBhcmFtZXRlcnMucHJpY2VMaW1pdCkgfHwgIWlzRmluaXRlKHBhcmFtZXRlcnMucHJpY2VMaW1pdCkpKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBQYXNzZWQgaW52YWxpZCBwcmljZSBsaW1pdCAtIFwiJHtwYXJhbWV0ZXJzLnByaWNlTGltaXR9XCIuYClcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgbGV0IGZsYXRzID0gdGhpcy5kYXRhYmFzZVxuICAgICAgICBcbiAgICAgICAgaWYgKHBhcmFtZXRlcnMucHJpY2VMaW1pdCAhPSBudWxsKSB7XG4gICAgICAgICAgZmxhdHMgPSBmbGF0cy5maWx0ZXIoKGZsYXQpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBmbGF0LnByaWNlIDw9IHBhcmFtZXRlcnMucHJpY2VMaW1pdFxuICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGNvbnN0IGRhdGVSYW5nZSA9IHRoaXMuX2dlbmVyYXRlRGF0ZVJhbmdlKHBhcmFtZXRlcnMuY2hlY2tJbkRhdGUsIHBhcmFtZXRlcnMuY2hlY2tPdXREYXRlKVxuICAgICAgICBmbGF0cyA9IGZsYXRzLmZpbHRlcigoZmxhdCkgPT4ge1xuICAgICAgICAgIHJldHVybiB0aGlzLl9hcmVBbGxEYXRlc0F2YWlsYWJsZShmbGF0LCBkYXRlUmFuZ2UpXG4gICAgICAgIH0pXG4gICAgICAgIFxuICAgICAgICBmbGF0cyA9IGZsYXRzLm1hcCgoZmxhdCkgPT4ge1xuICAgICAgICAgIHJldHVybiB0aGlzLl9mb3JtYXRGbGF0T2JqZWN0KGZsYXQsIGRhdGVSYW5nZS5sZW5ndGggLSAxKVxuICAgICAgICB9KVxuXG4gICAgICAgIHJlc29sdmUoZmxhdHMpXG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICByZWplY3QoZXJyb3IpXG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIC8qKlxuICAgICAqIEJvb2sgZmxhdC5cbiAgICAgKiBcbiAgICAgKiBAcGFyYW0ge251bWJlcn0gZmxhdElkIFxuICAgICAqIEBwYXJhbSB7RGF0ZX0gY2hlY2tJbkRhdGUgXG4gICAgICogQHBhcmFtIHtEYXRlfSBjaGVja091dERhdGVcbiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfVxuICAgICAqL1xuICBib29rKGZsYXRJZCwgY2hlY2tJbkRhdGUsIGNoZWNrT3V0RGF0ZSkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBmbGF0ID0gdGhpcy5kYXRhYmFzZS5maW5kKChpdGVtKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIGl0ZW0uaWQgPT09IGZsYXRJZFxuICAgICAgICB9KVxuICAgICAgICBcbiAgICAgICAgaWYgKGZsYXQgPT0gbnVsbCkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVGhlcmUgaXMgbm8gZmxhdCB3aXRoIElEIFwiJyArIGZsYXRJZCArICdcIi4nKVxuICAgICAgICB9XG4gICAgICAgIHRoaXMuX2Fzc2VydERhdGVzQXJlQ29ycmVjdChjaGVja0luRGF0ZSwgY2hlY2tPdXREYXRlKVxuICAgICAgICBcbiAgICAgICAgY29uc3QgZGF0ZXNUb0Jvb2sgPSB0aGlzLl9nZW5lcmF0ZURhdGVSYW5nZShjaGVja0luRGF0ZSwgY2hlY2tPdXREYXRlKVxuICAgICAgICBpZiAoIXRoaXMuX2FyZUFsbERhdGVzQXZhaWxhYmxlKGZsYXQsIGRhdGVzVG9Cb29rKSkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRmxhdCAke2ZsYXQuaWR9IGlzIG5vdCBhdmFpbGFibGUgZm9yIGRhdGVzICR7ZGF0ZXNUb0Jvb2suam9pbihcIixcIil9LmApXG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGNvbnN0IGJvb2tlZERhdGVzID0gZGF0ZXNUb0Jvb2subWFwKChkYXRlKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIGRhdGUuZ2V0VGltZSgpXG4gICAgICAgIH0pXG4gICAgICAgIGZsYXQuYm9va2VkRGF0ZXMucHVzaCguLi5ib29rZWREYXRlcylcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmRhdGFiYXNlLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgaWYgKHRoaXMuZGF0YWJhc2VbaV0uaWQgPT09IGZsYXQuaWQpIHtcbiAgICAgICAgICAgIHRoaXMuZGF0YWJhc2VbaV0gPSBmbGF0XG4gICAgICAgICAgICBicmVha1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB0aGlzLl93cml0ZURhdGFiYXNlKHRoaXMuZGF0YWJhc2UpXG4gICAgICAgIFxuICAgICAgICByZXNvbHZlKHRoaXMuX2dlbmVyYXRlVHJhbnNhY3Rpb25JZCgpKVxuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgcmVqZWN0KGVycm9yKVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBfYXNzZXJ0RGF0ZXNBcmVDb3JyZWN0KGNoZWNrSW5EYXRlLCBjaGVja091dERhdGUpIHtcbiAgICBjb25zdCB0b2RheSA9IG5ldyBEYXRlKClcbiAgICB0aGlzLl9yZXNldFRpbWUodG9kYXkpXG4gICAgdGhpcy5fcmVzZXRUaW1lKGNoZWNrSW5EYXRlKVxuICAgIHRoaXMuX3Jlc2V0VGltZShjaGVja091dERhdGUpXG5cbiAgICBjb25zdCBkaWZmVG9kYXkgPSB0aGlzLl9jYWxjdWxhdGVEaWZmZXJlbmNlSW5EYXlzKHRvZGF5LCBjaGVja0luRGF0ZSlcbiAgICBpZiAoZGlmZlRvZGF5IDwgMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDaGVjay1pbiBkYXRlIGNhblxcJ3QgYmUgaW4gdGhlIHBhc3QuJylcbiAgICB9XG5cbiAgICBjb25zdCBkaWZmQ2hlY2sgPSB0aGlzLl9jYWxjdWxhdGVEaWZmZXJlbmNlSW5EYXlzKGNoZWNrSW5EYXRlLCBjaGVja091dERhdGUpXG4gICAgaWYgKGRpZmZDaGVjayA8IDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2hlY2stb3V0IGRhdGUgbXVzdCBiZSBncmF0ZXIgdGhlbiBjaGVjay1pbiBkYXRlLicpXG4gICAgfVxuICB9XG5cbiAgX3Jlc2V0VGltZShkYXRlKSB7XG4gICAgZGF0ZS5zZXRIb3VycygwKVxuICAgIGRhdGUuc2V0TWludXRlcygwKVxuICAgIGRhdGUuc2V0U2Vjb25kcygwKVxuICAgIGRhdGUuc2V0TWlsbGlzZWNvbmRzKDApXG4gIH1cblxuICBfY2FsY3VsYXRlRGlmZmVyZW5jZUluRGF5cyhzdGFydERhdGUsIGVuZERhdGUpIHtcbiAgICBjb25zdCBkaWZmZXJlbmNlID0gZW5kRGF0ZS5nZXRUaW1lKCkgLSBzdGFydERhdGUuZ2V0VGltZSgpXG5cbiAgICByZXR1cm4gTWF0aC5mbG9vcihkaWZmZXJlbmNlIC8gKDEwMDAgKiA2MCAqIDYwICogMjQpKVxuICB9XG5cbiAgX2dlbmVyYXRlRGF0ZVJhbmdlKGZyb20sIHRvKSB7XG4gICAgY29uc3QgZGF0ZXMgPSBbXVxuICAgIGNvbnN0IGRpZmZlcmVuY2VJbkRheXMgPSB0aGlzLl9jYWxjdWxhdGVEaWZmZXJlbmNlSW5EYXlzKGZyb20sIHRvKVxuICAgICAgICBcbiAgICBkYXRlcy5wdXNoKG5ldyBEYXRlKGZyb20uZ2V0RnVsbFllYXIoKSwgZnJvbS5nZXRNb250aCgpLCBmcm9tLmdldERhdGUoKSkpXG4gICAgZm9yIChsZXQgaSA9IDE7IGkgPD0gZGlmZmVyZW5jZUluRGF5czsgaSsrKSB7XG4gICAgICBkYXRlcy5wdXNoKG5ldyBEYXRlKGZyb20uZ2V0RnVsbFllYXIoKSwgZnJvbS5nZXRNb250aCgpLCBmcm9tLmdldERhdGUoKSArIGkpKVxuICAgIH1cbiAgICBcbiAgICByZXR1cm4gZGF0ZXNcbiAgfVxuXG4gIF9nZW5lcmF0ZVRyYW5zYWN0aW9uSWQgPSAoKSA9PiB7XG4gICAgY29uc3QgbWluID0gMTAwMFxuICAgIGNvbnN0IG1heCA9IDk5OTlcbiAgICBjb25zdCBudW0gPSBNYXRoLnJhbmRvbSgpICogKG1heCAtIG1pbikgKyBtaW5cbiAgICBcbiAgICByZXR1cm4gTWF0aC5mbG9vcihudW0pXG4gIH1cblxuICBfYXJlQWxsRGF0ZXNBdmFpbGFibGUoZmxhdCwgZGF0ZVJhbmdlKSB7XG4gICAgcmV0dXJuIGRhdGVSYW5nZS5ldmVyeSgoZGF0ZSkgPT4ge1xuICAgICAgcmV0dXJuICFmbGF0LmJvb2tlZERhdGVzLmluY2x1ZGVzKGRhdGUuZ2V0VGltZSgpKVxuICAgIH0pXG4gIH1cblxuICBfZm9ybWF0RmxhdE9iamVjdChmbGF0LCBuaWdodE51bWJlcikge1xuICAgIGNvbnN0IGZvcm1hdHRlZEZsYXQgPSBPYmplY3QuYXNzaWduKHt9LCBmbGF0KVxuXG4gICAgZm9ybWF0dGVkRmxhdC5waG90b3MgPSBmb3JtYXR0ZWRGbGF0LnBob3Rvcy5tYXAoKHBob3RvVXJsKSA9PiB7XG4gICAgICByZXR1cm4gYGh0dHA6Ly9sb2NhbGhvc3Q6JHtiYWNrZW5kUG9ydH0vaW1nLyR7cGhvdG9Vcmx9YFxuICAgIH0pXG5cbiAgICBpZiAobmlnaHROdW1iZXIgIT0gbnVsbCkge1xuICAgICAgZm9ybWF0dGVkRmxhdC50b3RhbFByaWNlID0gbmlnaHROdW1iZXIgKiBmb3JtYXR0ZWRGbGF0LnByaWNlXG4gICAgICBkZWxldGUgZm9ybWF0dGVkRmxhdC5wcmljZVxuICAgIH1cblxuICAgIHJldHVybiBmb3JtYXR0ZWRGbGF0XG4gIH1cblxuICBfcmVhZERhdGFiYXNlKCkge1xuICAgIGNvbnN0IGRhdGEgPSB3aW5kb3cubG9jYWxTdG9yYWdlLmdldEl0ZW0obG9jYWxTdG9yYWdlS2V5KVxuXG4gICAgaWYgKGRhdGEgPT0gbnVsbCkge1xuICAgICAgcmV0dXJuIGRhdGFcbiAgICB9XG5cbiAgICByZXR1cm4gSlNPTi5wYXJzZShkYXRhKVxuICB9XG5cbiAgX3dyaXRlRGF0YWJhc2UoZGF0YWJhc2UpIHtcbiAgICB3aW5kb3cubG9jYWxTdG9yYWdlLnNldEl0ZW0obG9jYWxTdG9yYWdlS2V5LCBKU09OLnN0cmluZ2lmeShkYXRhYmFzZSkpXG4gIH1cblxuICBfc3luY0RhdGFiYXNlKGRhdGFiYXNlKSB7XG4gICAgdGhpcy5fd3JpdGVEYXRhYmFzZShkYXRhYmFzZSlcbiAgICB0aGlzLmRhdGFiYXNlID0gdGhpcy5fcmVhZERhdGFiYXNlKClcbiAgfVxufVxuIl19
